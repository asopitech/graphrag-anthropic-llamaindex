# 要件定義書

## 概要

DRIFT Search（Dynamic Retrieval with Interactive Filtering and Transformations、動的検索とインタラクティブフィルタリング・変換機能）は、GraphRAGシステムのローカル検索とグローバル検索のアプローチを組み合わせた高度な検索機能です。この機能は、インテリジェントなコンテキストフィルタリングと階層的情報検索による動的なクエリ処理を可能にし、基本的なベクター類似度検索と比較してより細やかで文脈的に関連性の高い検索結果を提供します。

## 製品ビジョンとの整合性

この機能は、エンティティレベルとコミュニティレベルの両方の情報を活用する高度な検索メカニズムを提供することで、GraphRAGのコア機能を強化します。複雑な文書コレクションからの包括的な知識検索を、高い関連性とコンテキスト認識を維持しながら提供するという製品目標をサポートします。

## 要件

### 要件1

**ユーザーストーリー:** ユーザーとして、インデックス化された文書に対してDRIFT検索を実行し、ローカルエンティティの詳細とグローバルコミュニティの洞察を組み合わせた、より文脈的に関連性の高い結果を得たい。

#### 受入基準

1. ユーザーがDRIFT検索クエリを送信した場合、システはローカル検索とグローバル検索メカニズムの両方を使用してクエリを処理する
2. クエリがナレッジグラフ内のエンティティに一致する場合、システムは関連するエンティティの説明と関係性を取得する
3. エンティティの一致が見つかり、かつコミュニティコンテキストが存在する場合、システムは関連するコミュニティサマリをレスポンスに含める
4. レスポンスを生成する際、システムは設定可能なローカルプロンプトとリデュースプロンプトを持つ構造化されたプロンプトシステムを使用する

### 要件2

**ユーザーストーリー:** ユーザーとして、DRIFT検索でリアルタイムに結果をストリーミング受信し、完全な処理を待つことなく生成されるレスポンスを確認したい。

#### 受入基準

1. DRIFT検索が開始された場合、システムは非同期ジェネレータとして結果を返す
2. 検索がストリーミング用に設定されている場合、システムはレスポンスチャンクを段階的に出力する
3. 各チャンクが生成された際、システムはレスポンスの一貫性とコンテキストの継続性を維持する

### 要件3

**ユーザーストーリー:** ユーザーとして、DRIFT検索でレスポンスと共にコンテキストデータを取得し、検索結果の背景にあるソースと推論を理解したい。

#### 受入基準

1. DRIFT検索が完了した場合、システムはレスポンステキストとコンテキストデータの両方を返す
2. レスポンスでエンティティが参照される場合、システムはエンティティのメタデータをコンテキストに含める
3. コミュニティがレスポンスに寄与する場合、システムはコミュニティ情報をコンテキストに含める
4. テキストユニットが参照される場合、システムはテキストユニットの詳細をコンテキストに含める

### 要件4

**ユーザーストーリー:** 開発者として、DRIFT検索を既存のベクターストアと統合し、現在のLanceDBインフラストラクチャを活用したい。

#### 受入基準

1. DRIFT検索が設定された場合、システムは既存のベクターストア設定を使用する
2. エンティティ埋め込みが必要な場合、システムはエンティティ説明埋め込みストアからそれらを取得する
3. コミュニティ埋め込みが必要な場合、システムはコミュニティフルコンテンツ埋め込みストアにアクセスする

## 非機能要件

### コードアーキテクチャとモジュラリティ
- **単一責任原則**: DRIFT検索機能は専用モジュールに分離する
- **モジュラー設計**: 検索コンポーネントは再利用可能で設定可能にする
- **依存関係管理**: 他の検索実装との結合を最小限に抑える
- **明確なインターフェース**: 既存の検索インフラストラクチャとの明確な契約を定義する

### パフォーマンス
- 典型的なクエリのレスポンス時間は5秒未満
- ストリーミングレスポンスはクエリ送信から1秒以内に開始
- 検索操作中のメモリ使用量は2GBを超えない
- 著しいパフォーマンス低下なしに同時検索をサポート

### セキュリティ
- インジェクション攻撃を防ぐためのすべての検索クエリの入力検証
- ユーザーに返す前のレスポンスデータのサニタイゼーション
- 情報漏洩を回避する適切なエラーハンドリング

### 信頼性
- ベクターストアが利用できない場合の段階的劣化
- デバッグのための適切なエラーハンドリングとログ記録
- 埋め込みが見つからない場合のフォールバックメカニズム
- 同一クエリに対する一貫した結果

### ユーザビリティ
- 不正なクエリに対する明確なエラーメッセージ
- YAML設定を通じた設定可能な検索パラメータ
- 異なるレスポンスタイプ（文字列、構造化データ）のサポート
- 既存のCLIとWebインターフェースとの統合